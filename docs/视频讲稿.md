# 视频讲稿

3-5分钟短视频，包含：

- 自我介绍
- 硬件介绍（控制器及外设，应用方向及应用场景）
- 设计思路（用板子的哪些模块实现了什么功能）
- 指定功能演示：
    - 驱动LED灯亮，使其实现呼吸灯的效果；
    - 成功驱动SPI、I2C、UART三个外设中的其中一个，且在拍视频时显示出来。



![](../images/Funpack_第一期封面.png)



> Hello，大家好！我是 Rudy。
>
> 欢迎来到得捷电子和硬禾学堂联合推出的 Funpack 第一期，本期的主角是来自 Seeed 科技的奥德赛 STM32MP157C 开发板。
>
> 本期视频主要分为三部分：
>
> 1. 介绍 ODYSSEY-STM32MP157C
> 2. 驱动 GPIO 实现呼吸灯
> 3. 驱动 UART 读取传感器



## 01 ODYSSEY-STM32MP157C

Seeed 的 ODYSSEY-STM32MP157C 是我个人非常喜欢的一款开发板，首先它的尺寸和树莓派一样，非常小巧。其次，它搭载了意法半导体的首款 MPU —— STM32MP157，拥有丰富的学习资源和生态。同时，它采用核心板 + 载板的设计，硬件设计完全开源，不仅适合学习，还可以用于产品开发。

![](../images/Funpack_第一期001.png)

这是一款我个人非常喜欢的开发板，首先它的尺寸和树莓派一样，非常小巧。其次，它搭载了意法半导体的首款 MPU，拥有丰富的学习资源和生态。同时，它采用核心板 + 载板的设计，硬件设计完全开源，不仅适合学习，还可以用于产品开发。

STM32MP157C 包含2个 Cortex-A7 和 1个 Cortex-M4，A7 核可以运行 Linux 系统，有丰富的软件支持，而 M4 核可以运行 RTOS，处理实时任务。

同时，这款开发板还配备了以太网口、WiFi 和蓝牙功能，可以快速搭建物联网应用。

此外，它还提供了与树莓派完全兼容的 40 pin 扩展接口，可以很方便地连接树莓派的生态资源。

因此，STM32MP1 系列芯片非常适用于工业制造、医疗、智能家居、消费电子等领域。

![](../images/布局.png)

STM32MP157C 包含2个Cortex-A7 和 1个 Cortex-M4，主频高达800MHz，A7 核可以运行 Linux 系统，因此有丰富的软件支持，而 M4 核可以运行 RTOS，处理实时任务。

![](../images/Funpack_第一期002.png)

同时，这款开发板上还配备了以太网口、WiFi 和蓝牙功能，可以快速搭建物联网应用。

![](../images/Funpack_第一期003.png)

此外，还提供了与树莓派完全兼容的 40 pin 扩展接口，因此可以很方便地连接树莓派的生态资源。

![](../images/Funpack_第一期004.png)



![](../images/Funpack_第一期005.png)



## 设计思路

我设计的这个 Demo 主要有两个功能：

第一个是驱动 GPIO 实现呼吸灯，我们知道呼吸灯的实现，通常采用 **DAC 数模转换** 和 **PWM 脉宽调制** 两种方式，本案例使用 PWM 控制来实现，通过调节一个周期内的方波占空比，实现宏观上的明暗调节。由于 STM32MP157 包含 Cortex-A7 和 Cortex-M4，所以其实在两边都可以实现。我选择在 Cortex-M4 中实现，通过 STM32CubeIDE 生成固件，然后在 Linux 中加载并启动该固件。

另一个功能是驱动 UART 串口读取传感器数据，我选择了一款攀藤的空气质量传感器 PMS5003ST，它可以采集 PM1.0、PM2.5、甲醛浓度以及环境温度和湿度等数据。本案例我们将通过 UART2 获取这些数据，并且通过 WiFi 将数据上传到阿里云物联网平台。

![](../images/功能实现框图.png)



## 02 实现 LED 呼吸灯

OK，现在我已经打开了调试串口，并且在 PA3 接了一个 LED，在 UART2 连接了一个传感器。

登录终端，输入 `gpioinfo gpiochip0`，可以看到 PA3 处于 input 状态。我这里已经写好了一个 shell 脚本，它可以控制 LED 的闪烁，我们执行来看一下。可以看到 LED 已经在闪烁了。

我们再打开一个终端，再来看一下 PA3 的状态，已经变成 output 了。

那我们怎么实现呼吸灯呢？我已经事先通过 STM32CubeIDE 创建了一个工程，配置PA3引脚为定时器控制功能，并配置好了 timer 2 的参数。然后在 main 函数里面修改 PWM 的占空比。编译生成的 elf 文件我已经放在 /lib/firmware 目录底下，那我现在就可以加载并启动该固件。

```shell
sudo echo xxx > 
sudo echo start >
```

可以看到呼吸灯已经运行起来了！

接下来我们通过 UART2 读取传感器数据，我已经事先编译设备树文件，并在 Linux中驱动了 uart2，它对应的设备节点是 /dev/ttySTM2。因此我可以通过 Python 来打开这个串口，进行读写操作，从而获取传感器数据。

由于 PMS5003ST 传感器默认进入主动输出模式，所以程序启动后会先将其设置为被动模式，然后进行周期查询，可以看到应用程序已经获取到传感器数据了。

我在阿里云上面已经创建好对应的产品和设备了，并在开发板上安装了 paho-mqtt，通过设备三元组信息与阿里云物联网平台进行绑定。

程序运行后，可以看到，网页上的状态已经变为“在线”，并且已经接收到设备上传的数据。







## 03 通过 UART 读取传感器数据





OK，我们已经正确读取到来自 PMS5003ST 传感器的数据。

前面我们说过，这个板子配备以太网、WiFi 和蓝牙功能，所以我们可以进一步把传感器数据上传到物联网云平台上。

此时，板上的 WiFi 功能已经打开，并且已经连接上我的局域网。

```shell
ifconfig wlan0
ping www.eetree.cn
```

我已经事先在阿里云物联网平台上创建了一个产品和设备，包含六个属性——PM1.0、PM2.5、PM10、甲醛浓度，以及温度和湿度，对应传感器中采集的数据。

设备端和云端通过三元组信息绑定，